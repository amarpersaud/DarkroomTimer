const StepDurationType=Object.freeze({SECONDS:"seconds",TIMES:"times",INVERSIONS:"inversions"});Object.freeze(StepDurationType);var depth_limit=3;class DevelopmentStep{step_id=0;step_type="Chemical";step_name="DefaultStepName";step_duration=60;step_repeat_enabled=false;step_repeat_until_end=false;step_repeat_count=0;step_frequency=30;step_temperature=20;sub_steps=[];step_parent=-1;depth=0;constructor(id,type,name,duration,repeat_enabled,repeat_until_end,freq,temperature,sub_steps,depth){this.step_id=id;this.step_type=type;this.step_name=name;this.step_duration=duration;this.step_repeat_enabled=repeat_enabled;this.step_repeat_until_end=repeat_until_end;this.step_frequency=freq;this.step_temperature=temperature;this.sub_steps=sub_steps;this.depth=depth;}
find_element_by_id(step_id){if(this.step_id==step_id){return this;}
for(let i=0;i<this.sub_steps.length;i++){let q=this.sub_steps[i].find_element_by_id(step_id);if(q!=null){return q;}}
return null;}
remove_element_by_id(step_id){for(let i=0;i<this.sub_steps.length;i++){if(this.sub_steps[i].step_id==step_id){this.sub_steps.splice(i,1);return;}
this.sub_steps[i].remove_element_by_id(step_id);}}
get_max_step_id(){let current_max=this.step_id;for(let i=0;i<this.sub_steps.length;i++){let sub_step_max=this.sub_steps[i].get_max_step_id()
if(sub_step_max>current_max){current_max=sub_step_max;}}
return current_max;}}
class DevelopmentProfile{RootStep=null;ProfileName="Unnamed Profile";PourInTime=0;PourOutTime=0;current_step_id=0;editing_enabled=true;current_editing_step_id=-1;constructor(RootStep,ProfileName,PourInTime,PourOutTime){this.RootStep=RootStep;this.ProfileName=ProfileName;this.PourInTime=PourInTime;this.PourOutTime=PourOutTime;}
RecalculateStepID(){let maxStepID=this.RootStep.get_max_step_id();this.current_step_id=maxStepID+1;}}
var m_RootStep=new DevelopmentStep(-1,"","",0,false,false,0,20,[],0);var CurrentProfile=new DevelopmentProfile(m_RootStep,"Unnamed Profile 2",0,0);function index_of_step_id(step_id){for(let i=0;i<CurrentProfile.RootStep.sub_steps.length;i++){if(CurrentProfile.RootStep.sub_steps[i].step_id==step_id){return i;}}
return-1;}
function recurse_find_step_id(itm,step_id){if(itm.step_id==step_id){return itm;}
for(let i=0;i<CurrentProfile.RootStep.sub_steps.length;i++){let q=recurse_find_step_id(CurrentProfile.RootStep.sub_steps[i],step_id);if(q!=null){return q;}}
return null;}
function UpdateProfileSettings(){let pn=document.getElementById("profileNameTextbox");let pit=document.getElementById("PourInTimeInput");let pot=document.getElementById("PourOutTimeInput");CurrentProfile.ProfileName=pn.value;CurrentProfile.PourInTime=pit.value;CurrentProfile.PourOutTime=pot.value;}
function step_save_edit_clicked(){let itm=CurrentProfile.RootStep.find_element_by_id(CurrentProfile.current_editing_step_id);let new_step_name=document.getElementById("step_name_edit").value;let new_step_duration=document.getElementById("step_duration_edit").value;let new_step_type=document.getElementById("step_type_edit").value;let new_step_frequency=document.getElementById("step_frequency_edit").value;let new_step_frequency_duration=document.getElementById("step_frequency_duration_edit").value;let new_repeat_enabled=document.getElementById("step_repeat_edit").checked;let new_repeat_until_end=document.getElementById("step_repeat_until_end_edit").checked;let new_step_temp=document.getElementById("step_temperature_edit").value;itm.step_name=new_step_name;itm.step_duration=new_step_duration;itm.step_type=new_step_type;itm.step_frequency=new_step_frequency;itm.step_frequency_duration=new_step_frequency_duration;itm.repeat_enabled=new_repeat_enabled;itm.repeat_until_end=new_repeat_until_end;itm.step_temperature=new_step_temp;refreshUI();}
function step_add_edit_clicked(){let new_step_name=document.getElementById("step_name_edit").value;let new_step_duration=document.getElementById("step_duration_edit").value;let new_step_type=document.getElementById("step_type_edit").value;let new_step_frequency=document.getElementById("step_frequency_edit").value;let new_step_frequency_duration=document.getElementById("step_frequency_duration_edit").value;let new_repeat_enabled=document.getElementById("step_repeat_edit").checked;let new_repeat_until_end=document.getElementById("step_repeat_until_end_edit").checked;let new_step_temp=document.getElementById("step_temperature_edit").value;CurrentProfile.current_editing_step_id=CurrentProfile.current_step_id;add_step(new_step_name,new_step_type,new_step_duration,new_repeat_enabled,new_repeat_until_end,new_step_frequency,new_step_temp,[]);CurrentProfile.RecalculateStepID();}
function step_repeat_enabled_changed(sender){let should_repeat=sender.checked;}
function move_up_clicked(step_id){let itm=CurrentProfile.RootStep.find_element_by_id(step_id);let parent=CurrentProfile.RootStep.find_element_by_id(itm.step_parent);let ind=-1;for(let i=0;i<parent.sub_steps.length;i++){if(parent.sub_steps[i].step_id==step_id){ind=i;}}
if(ind>0){let temp=parent.sub_steps[ind-1];parent.sub_steps[ind-1]=parent.sub_steps[ind];parent.sub_steps[ind]=temp;}
refreshUI();}
function move_down_clicked(step_id){let itm=CurrentProfile.RootStep.find_element_by_id(step_id);let parent=CurrentProfile.RootStep.find_element_by_id(itm.step_parent);let ind=-1;for(let i=0;i<parent.sub_steps.length;i++){if(parent.sub_steps[i].step_id==step_id){ind=i;}}
if(ind<parent.sub_steps.length-1&&ind>=0){let temp=parent.sub_steps[ind+1];parent.sub_steps[ind+1]=parent.sub_steps[ind];parent.sub_steps[ind]=temp;}
refreshUI();}
function step_edit_clicked(step_id){start_edit_step(step_id);refreshUI();}
function step_add_to_clicked(step_id){let itm=CurrentProfile.RootStep.find_element_by_id(step_id);if(itm!=null&&itm.depth<depth_limit){let new_step_name=document.getElementById("step_name_edit").value;let new_step_duration=document.getElementById("step_duration_edit").value;let new_step_type=document.getElementById("step_type_edit").value;let new_step_frequency=document.getElementById("step_frequency_edit").value;let new_step_frequency_duration=document.getElementById("step_frequency_duration_edit").value;let new_step_repeat_enabled=document.getElementById("step_repeat_edit").checked;let new_step_repeat_until_end=document.getElementById("step_repeat_until_end_edit").checked;let new_step_temp=document.getElementById("step_temperature_edit").value;let new_step=new DevelopmentStep(CurrentProfile.current_step_id,new_step_type,new_step_name,new_step_duration,new_step_repeat_enabled,new_step_repeat_until_end,new_step_frequency,new_step_temp,[],itm.depth+1);new_step.step_parent=itm.step_id;CurrentProfile.current_editing_step_id=CurrentProfile.current_step_id;itm.sub_steps.push(new_step);CurrentProfile.RecalculateStepID();}
refreshUI();}
function editing_clicked(){CurrentProfile.editing_enabled=document.getElementById("EnableEditingCheckbox").checked;refreshUI();}
function start_edit_step(step_id){let itm=CurrentProfile.RootStep.find_element_by_id(step_id);console.log("editing step id: "+step_id.toString());CurrentProfile.current_editing_step_id=step_id;document.getElementById("step_name_edit").value=itm.step_name;document.getElementById("step_duration_edit").value=itm.step_duration;document.getElementById("step_type_edit").value=itm.step_type;document.getElementById("step_frequency_edit").value=itm.step_frequency;document.getElementById("step_repeat_edit").checked=itm.step_repeat_enabled;document.getElementById("step_repeat_until_end_edit").checked=itm.step_repeat_until_end;document.getElementById("step_temperature_edit").value=itm.step_temperature;refreshUI();}
function delete_step(step_id){CurrentProfile.RootStep.remove_element_by_id(step_id);CurrentProfile.RecalculateStepID();refreshUI();}
function add_step(step_name,step_type,step_duration,step_repeat_enabled,step_repeat_until_end,step_frequency,step_temperature,step_sub_steps){let new_step=new DevelopmentStep(CurrentProfile.current_step_id,step_type,step_name,step_duration,step_repeat_enabled,step_repeat_until_end,step_frequency,step_temperature,step_sub_steps,1);new_step.step_parent=CurrentProfile.RootStep.step_id;CurrentProfile.RootStep.sub_steps.push(new_step);CurrentProfile.RecalculateStepID();refreshUI();}
function clear_ui_step_list(){let step_list_m=document.getElementById("main_step_list");step_list_m.innerHTML="";}
function populate_ui_step_list(){for(let i=0;i<CurrentProfile.RootStep.sub_steps.length;i++){let itm=CurrentProfile.RootStep.sub_steps[i];let clon=build_step_HTML_recursive(itm,i);let addto=document.getElementById("main_step_list");addto.appendChild(clon);}}
function build_step_HTML_recursive(itm,step_num){let temp=null;if(CurrentProfile.editing_enabled){temp=document.getElementById("step_editing_template");}
else{temp=document.getElementById("step_template");}
let clon=temp.content.firstElementChild.cloneNode(true);if((itm.step_id==CurrentProfile.current_editing_step_id)&&CurrentProfile.editing_enabled){clon.setAttribute("class","step edited_step")}
clon.querySelector(".step_num").innerHTML=step_num.toString()+" - "+itm.step_name;clon.querySelector(".step_duration").innerHTML=itm.step_duration.toString();clon.querySelector(".step_type").innerHTML=itm.step_type;clon.querySelector(".step_temp").innerHTML=itm.step_temperature.toString()+"C";if(itm.step_frequency===""){clon.querySelector(".step_frequency").innerHTML="N/A";}
else{clon.querySelector(".step_frequency").innerHTML=itm.step_frequency.toString();}
clon.querySelector(".step_temp").innerHTML=itm.step_temperature.toString()+"C";if(itm.step_repeat_enabled){if(itm.step_repeat_until_end){clon.querySelector(".step_repeat_enabled").innerHTML="Until End";}else{clon.querySelector(".step_repeat_enabled").innerHTML=itm.step_repeat_count;}}
else{clon.querySelector(".step_repeat_enabled").innerHTML="No";}
let buttons=clon.querySelectorAll("button");if(CurrentProfile.editing_enabled){buttons[0].setAttribute("onclick","move_up_clicked("+itm.step_id+")");buttons[1].setAttribute("onclick","move_down_clicked("+itm.step_id+")");buttons[2].setAttribute("onclick","delete_step("+itm.step_id+")");buttons[3].setAttribute("onclick","step_edit_clicked("+itm.step_id+")");buttons[4].setAttribute("onclick","step_add_to_clicked("+itm.step_id+")");}
for(let i=0;i<itm.sub_steps.length;i++){let child=build_step_HTML_recursive(itm.sub_steps[i],i);clon.querySelector("ul").appendChild(child);}
return clon;}
function refreshUI(){clear_ui_step_list();populate_ui_step_list();if(CurrentProfile.RootStep.sub_steps.length==0){document.getElementById("step_save_edit_button").disabled=true;}
else{document.getElementById("step_save_edit_button").disabled=false;}}
function ImportProfile(){let inp=document.getElementById("profileFile");if(inp.files.length==1){try{var reader=new FileReader();reader.readAsText(inp.files[0],'UTF-8');reader.onload=readerEvent=>{var content=readerEvent.target.result;let loadedProfile=JSON.parse(content);CurrentProfile=JsonLoadedProfileToDevelopmentProfile(loadedProfile);CurrentProfile.RecalculateStepID();refreshUI();let pn=document.getElementById("profileNameTextbox");let pit=document.getElementById("PourInTimeInput");let pot=document.getElementById("PourOutTimeInput");pn.value=CurrentProfile.ProfileName;pit.value=CurrentProfile.PourInTime;pot.value=CurrentProfile.PourOutTime;}}
catch(e){console.log("Failed to parse file");}}}
function ExportProfile(){let inp=document.getElementById("profileNameTextbox");let filename=inp.value+".json";const blob=new Blob([JSON.stringify(CurrentProfile,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename||'download.json';a.click();a.remove();}
function JsonLoadedStepToDevelopmentStep(JsonObj){if(JsonObj!=null){let newStep=new DevelopmentStep(JsonObj.step_id,JsonObj.step_type,JsonObj.step_name,JsonObj.step_duration,JsonObj.step_repeat_enabled,JsonObj.step_repeat_until_end,JsonObj.step_frequency,JsonObj.step_temperature,[],JsonObj.depth);newStep.step_parent=JsonObj.step_parent;for(let i=0;i<JsonObj.sub_steps.length;i++){newStep.sub_steps.push(JsonLoadedStepToDevelopmentStep(JsonObj.sub_steps[i]));}
return newStep;}
return null;}
function JsonLoadedProfileToDevelopmentProfile(JsonObj){if(JsonObj!=null){let newRootStep=JsonLoadedStepToDevelopmentStep(JsonObj.RootStep);let newProfile=new DevelopmentProfile(newRootStep,JsonObj.ProfileName,JsonObj.PourInTime,JsonObj.PourOutTime);return newProfile;}
return null;}